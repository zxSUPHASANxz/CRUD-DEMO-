{% extends 'base.html' %}
{% block content %}
<h2 class="text-2xl font-bold mb-6">üìä Admin Dashboard</h2>


<div class="flex flex-col md:flex-row gap-8">
  <!-- Users Table Left -->
  <div class="flex-1" x-data="userCrud()">
    <h3 class="text-xl font-semibold mb-3">Users</h3>
    <table class="w-full border-collapse bg-white shadow rounded-xl overflow-hidden">
      <thead>
        <tr class="bg-gray-200 text-left">
          <th class="p-2 border">ID_User</th>
          <th class="p-2 border">Username</th>
          <th class="p-2 border">Status</th>
          <th class="p-2 border">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr class="hover:bg-gray-50">
          <td class="p-2 border">{{ u.id|stringformat:"05d" }}</td>
          <td class="p-2 border">{{ u.username }}</td>
          <td class="p-2 border">{{ u.profile.status }}</td>
          <td class="p-2 border space-x-2">
            <button @click="openEdit('{{ u.id }}','{{ u.username }}','{{ u.profile.role }}')"
                    class="text-blue-600 hover:underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            {% if u.username != "Admin_THEONE" %}
            <a href="{% url 'delete_user' u.id %}" class="text-red-600 hover:underline">‡∏•‡∏ö</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>


    <!-- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç User -->
    <div x-show="show" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg w-96 p-6" @click.away="show=false">
        <h3 class="text-lg font-semibold mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç User</h3>
        <form @submit.prevent="confirm=true">
          <div class="mb-3">
            <label class="block text-sm font-medium">Username</label>
            <input x-model="form.username" class="w-full border rounded px-3 py-2">
          </div>
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï</button>
        </form>
      </div>
    </div>

    <!-- Confirm -->
    <div x-show="confirm" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg w-80 p-6 text-center">
        <h3 class="text-lg font-semibold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç?</h3>
        <div class="flex justify-center gap-4">
          <button @click="confirm=false" class="px-4 py-2 bg-gray-300 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button @click="updateUser()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mechanics Table Right -->
  <div class="flex-1" x-data="mechanicCrud()">
    <h3 class="text-xl font-semibold mb-3">Mechanics</h3>
    <table class="w-full border-collapse bg-white shadow rounded-xl overflow-hidden">
      <thead>
        <tr class="bg-gray-200 text-left">
          <th class="p-2 border">ID</th>
          <th class="p-2 border">Name</th>
          <th class="p-2 border">Status</th>
          <th class="p-2 border">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for m in mechanics %}
        <tr class="hover:bg-gray-50">
          <td class="p-2 border">{{ m.id|stringformat:"05d" }}</td>
          <td class="p-2 border">{{ m.name }}</td>
          <td class="p-2 border">-</td>
          <td class="p-2 border space-x-2">
      <button @click="openEdit('{{ m.id }}','{{ m.name }}')"
        class="text-blue-600 hover:underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <a href="{% url 'delete_mechanic' m.id %}" class="text-red-600 hover:underline">‡∏•‡∏ö</a>
          </td>
        </tr>
        {% endfor %}
        {# Show users with role Mechanic as well #}
        {% for u in mechanics_users %}
        <tr class="hover:bg-gray-50 bg-yellow-50">
          <td class="p-2 border">{{ u.id|stringformat:"05d" }}</td>
          <td class="p-2 border">{{ u.username }}</td>
          <td class="p-2 border">{{ u.profile.status }}</td>
          <td class="p-2 border space-x-2">
            <button @click="window.userCrud().openEdit('{{ u.id }}','{{ u.username }}','Mechanic')"
                    class="text-blue-600 hover:underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            {% if u.username != "Admin_THEONE" %}
            <a href="{% url 'delete_user' u.id %}" class="text-red-600 hover:underline">‡∏•‡∏ö</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Mechanic (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô User) -->
    <div x-show="show" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg w-96 p-6" @click.away="show=false">
        <h3 class="text-lg font-semibold mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Mechanic</h3>
        <form @submit.prevent="confirm=true">
          <div class="mb-3">
            <label class="block text-sm font-medium">Name</label>
            <input x-model="form.name" class="w-full border rounded px-3 py-2">
          </div>
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï</button>
        </form>
      </div>
    </div>

    <!-- Confirm -->
    <div x-show="confirm" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg w-80 p-6 text-center">
        <h3 class="text-lg font-semibold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç?</h3>
        <div class="flex justify-center gap-4">
          <button @click="confirm=false" class="px-4 py-2 bg-gray-300 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button @click="updateMechanic()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function userCrud(){
  return {
    show:false, confirm:false,
    form:{id:'', username:'', role:''},
  openEdit(id,username,role){ this.form={id,username,role:role||'User'}; this.show=true; },
    updateUser(){
      fetch(`/admin-dashboard/user/${this.form.id}/update/`, {
        method:'POST',
        headers:{'X-CSRFToken':'{{ csrf_token }}'},
        body:new URLSearchParams(this.form)
      }).then(()=>location.reload())
    }
  }
}
function mechanicCrud(){
  return {
    show:false, confirm:false,
    form:{id:'', name:''},
    openEdit(id,name){ this.form={id,name}; this.show=true; },
    updateMechanic(){
      fetch(`/admin-dashboard/mechanic/${this.form.id}/update/`, {
        method:'POST',
        headers:{'X-CSRFToken':'{{ csrf_token }}'},
        body:new URLSearchParams(this.form)
      }).then(()=>location.reload())
    }
  }
}
</script>
{% endblock %}
